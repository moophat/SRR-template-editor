name: Trigger Upstream Sync to Shared-Resources

on:
  push:
    branches: [main]
    paths:
      - 'template/**'

jobs:
  trigger-dispatch:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[auto-sync]')"
    steps:
      - name: Checkout consumer repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Need last 2 commits for diff

      - name: Determine changed folders
        id: changed-folders
        run: |
          # Get list of changed files in last commit
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

          # Map consumer paths to shared folder names
          FOLDERS=""
          if echo "$CHANGED_FILES" | grep -q "^template/jsnapy/"; then
            FOLDERS="$FOLDERS jsnapy"
          fi
          if echo "$CHANGED_FILES" | grep -q "^template/jinja2/"; then
            FOLDERS="$FOLDERS jinja2"
          fi
          if echo "$CHANGED_FILES" | grep -q "^template/ttp/"; then
            FOLDERS="$FOLDERS ttp"
          fi
          if echo "$CHANGED_FILES" | grep -q "^template/textfsm/"; then
            FOLDERS="$FOLDERS textfsm"
          fi
          if echo "$CHANGED_FILES" | grep -q "^template/tableview/"; then
            FOLDERS="$FOLDERS tableview"
          fi

          echo "folders=$FOLDERS" >> $GITHUB_OUTPUT
          echo "Changed folders: $FOLDERS"

      - name: Send repository_dispatch for each changed folder
        if: steps.changed-folders.outputs.folders != ''
        env:
          SHARED_REPO_PAT: ${{ secrets.SHARED_REPO_PAT }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n1)

          for folder in ${{ steps.changed-folders.outputs.folders }}; do
            echo "ðŸ“¤ Dispatching upstream sync for folder: $folder"

            curl -X POST \
              -H "Authorization: token $SHARED_REPO_PAT" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/moophat/SRR-shared-resources/dispatches \
              -d "{
                \"event_type\": \"push-upstream\",
                \"client_payload\": {
                  \"consumer\": \"template-editor\",
                  \"folder\": \"$folder\",
                  \"commit_sha\": \"$COMMIT_SHA\",
                  \"commit_message\": \"$COMMIT_MSG\"
                }
              }"

            echo "âœ… Dispatch sent for $folder"
          done
